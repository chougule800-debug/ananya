<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dr. Bharat's Arogya Homeopathy - Cloud System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="medicines.js"></script>

    <style>
        :root {
            --primary: #1e3a8a;
            --primary-hover: #1e40af;
            --primary-light: #eff6ff;
            --dr-red: #b91c1c;
            --text: #1f2937;
            --text-light: #4b5563;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --success: #059669;
            --error: #ef4444;
            --warning: #f59e0b;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            margin: 0; 
            padding: 20px; 
            line-height: 1.5;
        }

        .container { max-width: 1500px; margin: 0 auto; }

        /* --- CUSTOM SCROLLBARS --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- TOAST NOTIFICATION --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #1f2937; color: #fff;
            text-align: center; border-radius: 50px; padding: 12px 24px;
            position: fixed; z-index: 10000; left: 50%; bottom: 20px;
            transform: translateX(-50%) translateY(20px); font-size: 14px; font-weight: 500;
            box-shadow: var(--shadow-hover); opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); bottom: 40px; }
        #toast.success { background-color: var(--success); }
        #toast.error { background-color: var(--error); }

        /* --- AUTH & LOADING SCREENS --- */
        #authContainer, #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999; display: flex; justify-content: center; align-items: center;
        }
        #loadingOverlay { background: rgba(255,255,255,0.95); z-index: 10000; display: none; flex-direction: column; backdrop-filter: blur(4px); }
        
        .auth-card {
            background: var(--surface); padding: 48px 40px; border-radius: var(--radius-lg); width: 100%; max-width: 420px;
            box-shadow: var(--shadow-hover); text-align: center; border-top: 6px solid var(--primary);
        }
        .auth-title { color: var(--primary); font-weight: 900; font-size: 24px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: -0.5px; }
        .auth-subtitle { color: var(--text-light); font-size: 14px; margin-bottom: 32px; }
        
        .spinner {
            width: 40px; height: 40px; border: 4px solid var(--border); border-top: 4px solid var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 16px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- HEADER --- */
        .app-header {
            background: var(--surface); padding: 20px 30px; border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 24px; border: 1px solid var(--border); border-left: 6px solid var(--primary);
        }

        .header-left h1 { 
            color: var(--dr-red); font-size: 26px; margin: 0; font-weight: 900; 
            text-transform: uppercase; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px;
        }

        .header-right { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
        
        .nav-pills { display: flex; gap: 8px; background: var(--bg); padding: 6px; border-radius: 10px; border: 1px solid var(--border); }
        .nav-btn { 
            border: none; background: transparent; padding: 10px 20px; border-radius: var(--radius-md); 
            font-weight: 600; font-size: 14px; cursor: pointer; color: var(--text-light); 
            transition: all 0.2s ease; 
        }
        .nav-btn:hover { color: var(--primary); background: rgba(30, 58, 138, 0.05); }
        .nav-btn.active { background: var(--surface); color: var(--primary); box-shadow: var(--shadow-sm); }
        .logout-btn { color: var(--error) !important; }
        .logout-btn:hover { background: #fee2e2 !important; }

        /* --- LAYOUTS --- */
        .page { display: none; }
        .page.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card { 
            background: var(--surface); padding: 24px; border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); margin-bottom: 24px; border: 1px solid var(--border);
        }
        
        .grid-reception { display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px; }
        
        .grid-doctor { display: grid; grid-template-columns: 300px 1fr; gap: 24px; align-items: start; }

        .patient-list-section { 
            position: sticky; top: 20px; height: calc(100vh - 40px); 
            overflow-y: auto; display: flex; flex-direction: column;
        }

        .grid-3-top { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; } 
        
        /* --- FORMS & INPUTS --- */
        .form-group { margin-bottom: 16px; text-align: left; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: var(--text-light); margin-bottom: 6px; }
        
        input, select, textarea { 
            width: 100%; padding: 10px 12px; border: 1px solid var(--border); 
            border-radius: var(--radius-md); font-size: 14px; font-family: inherit;
            transition: all 0.2s; background: var(--bg); color: var(--text);
        }
        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary); background: var(--surface);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        textarea.auto-expand { resize: none; overflow-y: hidden; min-height: 44px; }

        .input-error { border-color: var(--error) !important; background-color: #fef2f2 !important; }

        /* --- BUTTONS --- */
        .btn { 
            padding: 10px 20px; border: none; border-radius: var(--radius-md); font-weight: 600; 
            cursor: pointer; display: inline-flex; align-items: center; justify-content: center; 
            gap: 8px; font-size: 14px; transition: all 0.2s ease; text-transform: letter-spacing: 0.2px;
        }
        .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-green { background: var(--success); color: white; }
        .btn-red { background: var(--error); color: white; }
        .btn-secondary { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .btn-secondary:hover { background: var(--bg); border-color: #cbd5e1; }
        .btn-yellow { background: var(--warning); color: white; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- DRUG ROWS --- */
        .drug-row { 
            display: flex; gap: 16px; align-items: flex-start; background: var(--surface); 
            padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border); 
            margin-bottom: 12px; box-shadow: var(--shadow-sm); position: relative;
        }
        
        .col-name { flex: 3; display: flex; flex-direction: column; gap: 8px; } 
        .col-weight { flex: 1.5; } 
        .col-small { flex: 0.8; text-align: center; background: var(--bg); padding: 8px; border-radius: var(--radius-md); } 
        .col-days { flex: 2; } 
        .col-total { flex: 1; } 
        .col-action { flex: 0.2; display: flex; align-items: center; justify-content: center; padding-top: 26px; }
        
        .drug-row label { display: block; font-size: 12px; font-weight: 700; color: var(--text-light); margin-bottom: 6px; }

        .form-check-group { display: flex; gap: 12px; margin-top: 4px; }
        .form-check-label { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-light); cursor: pointer; font-weight: 600; }
        .form-check-label input { width: 14px; height: 14px; margin: 0; cursor: pointer;}

        .dose-input-group { display: flex; flex-direction: column; align-items: center; gap: 8px; }
        .checkbox-label { font-size: 11px; color: var(--text-light); font-weight: bold; cursor: pointer; display: flex; align-items: center; }
        
        .duration-checks { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
        .dur-check-label { 
            font-size: 11px; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 4px; cursor: pointer;
            background: var(--surface); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); transition: all 0.2s;
        }
        .dur-check-label:hover { border-color: var(--primary); background: var(--primary-light); }

        .add-med-btn-inline {
            font-size: 12px; color: white; background: var(--primary); padding: 4px 10px; 
            border-radius: 6px; cursor: pointer; margin-top: 8px; display: inline-block; font-weight: 600; transition: 0.2s;
        }
        .add-med-btn-inline:hover { background: var(--primary-hover); }

        /* --- PATIENT LIST ITEM --- */
        .patient-list-item { 
            padding: 16px; border: 1px solid var(--border); border-radius: var(--radius-md); 
            margin-bottom: 10px; cursor: pointer; background: var(--surface); 
            transition: all 0.2s ease; position: relative; overflow: hidden;
        }
        .patient-list-item:hover { 
            border-color: #cbd5e1; transform: translateY(-2px); box-shadow: var(--shadow-md); 
        }
        .patient-list-item.selected { 
            background: var(--primary-light); border-color: var(--primary); 
        }
        .patient-list-item.selected::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--primary);
        }
        
        .patient-list-header { display: flex; justify-content: space-between; align-items: center; }
        .patient-list-header strong { font-size: 15px; color: var(--text); }

        .patient-details-expanded {
            max-height: 0; overflow: hidden; opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg); border-radius: var(--radius-md); margin-top: 0; padding: 0 12px;
        }
        .patient-list-item.expanded .patient-details-expanded {
            max-height: 120px; opacity: 1; margin-top: 12px; padding: 12px; border: 1px solid var(--border);
        }
        
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        .med-list-item { 
            display: flex; justify-content: space-between; padding: 16px; 
            border-bottom: 1px solid var(--border); align-items: center; transition: 0.2s;
        }
        .med-list-item:hover { background: var(--bg); }

        /* --- MIC STYLES & SWITCHES --- */
        .mic-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
        .mic-wrapper input, .mic-wrapper textarea { width: 100%; padding-right: 40px; }
        .mic-btn { 
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: none; border: none; cursor: pointer; color: #9ca3af;
            z-index: 10; padding: 4px; display: flex; align-items: center; border-radius: 50%; transition: 0.2s;
        }
        .mic-btn:hover { background: var(--bg); color: var(--text); }
        .mic-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .mic-btn.listening { color: var(--error); animation: pulse 1.5s infinite; background: #fee2e2; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        .auto-mic-container { 
            display: flex; align-items: center; gap: 10px; background: var(--surface); 
            padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border); box-shadow: var(--shadow-sm);
        }
        .switch-label { font-size: 13px; font-weight: 600; color: var(--text-light); }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.2);}
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(16px); }

        /* --- TEMPLATE CHIPS --- */
        .template-area { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; align-items: center; }
        .template-chip { 
            background: var(--surface); color: var(--primary); padding: 6px 14px; border-radius: 20px; 
            font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid #bae6fd; transition: all 0.2s; 
        }
        .template-chip:hover { background: var(--primary); color: white; border-color: var(--primary); transform: translateY(-1px); }
        
        .template-add-btn { 
            background: transparent; border: 1px dashed #94a3b8; color: var(--text-light); 
            padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; transition: 0.2s;
        }
        .template-add-btn:hover { border-color: var(--primary); color: var(--primary); background: var(--primary-light); }

        /* --- LAB GRID --- */
        .lab-grid-row1 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 16px; }
        .lab-grid-row2 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 16px; }
        .lab-input { text-align: center; font-weight: 600; color: var(--primary); }

        /* --- MODALS --- */
        .modal { 
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px);
            align-items: center; justify-content: center; 
        }
        .modal-content { 
            background-color: var(--surface); padding: 32px; border-radius: var(--radius-lg); 
            width: 90%; max-width: 500px; box-shadow: var(--shadow-hover); position: relative;
            animation: modalPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes modalPop { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .modal-title { font-weight: 800; font-size: 20px; margin: 0; color: var(--text); }
        .selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 12px; }
        .selection-btn { 
            padding: 12px; border: 1px solid var(--border); border-radius: var(--radius-md); background: var(--surface); 
            cursor: pointer; font-size: 13px; text-align: center; transition: all 0.2s; font-weight: 600; color: var(--text);
        }
        .selection-btn:hover { border-color: var(--primary); background: var(--primary-light); color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow-sm); }

        /* --- RESPONSIVE ADJUSTMENTS --- */
        @media (max-width: 1024px) {
            .grid-doctor { grid-template-columns: 1fr; }
            .patient-list-section { position: relative; height: auto; max-height: 400px; top: 0; }
            .grid-reception { grid-template-columns: 1fr; }
        }
        @media (max-width: 768px) {
            .app-header { flex-direction: column; align-items: flex-start; gap: 16px; }
            .nav-pills { width: 100%; justify-content: space-between; overflow-x: auto; }
            .nav-btn { padding: 8px 12px; font-size: 13px; white-space: nowrap; }
            .drug-row { flex-wrap: wrap; }
            .col-name, .col-days, .col-weight { flex: 1 1 100%; }
            .col-small { flex: 1 1 30%; }
            .col-total { flex: 1 1 50%; }
            .col-action { flex: 1 1 100%; text-align: right; padding-top: 0; }
        }

        /* PRINT STYLES (Kept exactly as requested) */
        @media print {
            @page { margin: 10mm; size: A4; }
            body, .container { background: white; margin: 0; padding: 0; max-width: 100%; }
            .no-print, .app-header, .patient-list-section, .btn, .card-header-actions, .auto-mic-container, .mic-btn, .add-med-link, #authContainer, #loadingOverlay, .template-area, .modal, .add-med-btn-inline { display: none !important; }
            .print-only { display: block !important; }
            .card { box-shadow: none; padding: 0; border: none; }
            .print-container { padding: 20px; font-family: 'Times New Roman', serif; }
            
            .print-header { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 5px; }
            .dr-info h1 { color: #b91c1c !important; font-size: 26px; margin: 0; font-weight: 900; text-transform: uppercase; display: flex; align-items: baseline; gap: 10px; }
            .dr-info .print-degree { font-size: 14px; color: #000; font-weight: 700; }
            .dr-info p { margin: 2px 0; font-size: 12px; font-weight: bold; color: #000; }
            .clinic-info-container { display: flex; align-items: center; gap: 15px; text-align: right; }
            .clinic-logo-img { height: 60px; width: auto; }
            .clinic-name { color: #1e3a8a !important; font-size: 20px; font-weight: 900; text-transform: uppercase; border: 2px solid #1e3a8a; padding: 2px 8px; display: inline-block; }
            
            .print-page { display: flex; flex-direction: column; position: relative; page-break-after: always; }
            .page-break-before { page-break-before: always; }
            #printPage2 { padding-top: 30px; }
            .rx-badge { text-align: center; margin: 20px 0; }
            .rx-badge span { background: #222; color: white !important; padding: 6px 30px; border-radius: 4px; font-weight: bold; letter-spacing: 2px; font-size: 16px; -webkit-print-color-adjust: exact; }
            
            .print-meta-grid { display: flex; justify-content: space-between; margin: 10px 0; font-weight: bold; font-size: 16px; border-bottom: 2px solid #000; padding-bottom: 5px; }
            
            .rx-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #000; }
            .rx-table th { border: 1px solid #000; padding: 6px; font-size: 12px; background: #e5e7eb !important; text-align: center; font-weight: bold; }
            .rx-table td { border: 1px solid #000; padding: 8px 5px; font-size: 16px; text-align: center; height: 40px; vertical-align: middle; font-weight: 600; color: #1e3a8a !important; }
            .rx-table td.drug-name-cell { text-align: left; padding-left: 15px; color: #000 !important; }
            
            .print-footer { margin-top: 50px; text-align: right; padding-bottom: 20px; }
            .signature-line { border-top: 1px solid #000; margin-top: 10px; padding-top: 5px; font-weight: bold; display: inline-block; width: 200px; text-align: center;}
            
            .print-section-box { border: 1px solid #000; padding: 5px 10px; margin-bottom: 8px; font-size: 14px; font-family: 'Inter', sans-serif; display: flex; align-items: baseline; gap: 10px; min-height: 35px;}
            .print-section-title { font-weight: bold; min-width: 140px; text-decoration: underline;}
            .print-section-content { font-weight: 600; flex-grow: 1; white-space: pre-wrap; }
            .print-details-box { border: 1px solid #000; padding: 10px; height: auto; min-height: 0; margin-bottom: 20px; font-size: 14px; white-space: pre-wrap; font-family: 'Inter', sans-serif; display: none; width: 100%; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

    <div id="toast"></div>

    <div id="loadingOverlay" style="display: none;">
        <div class="spinner"></div>
        <div style="font-weight:600; color:var(--text-light);">Loading...</div>
    </div>

    <div id="selectionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="selectionTitle">Select Option</h4>
                <button class="btn btn-red btn-sm" onclick="closeModal('selectionModal')">X</button>
            </div>
            <div class="modal-body selection-grid" id="selectionContainer"></div>
        </div>
    </div>

    <div id="manualDurationModal" class="modal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h4 class="modal-title">Custom Duration</h4>
                <button class="btn btn-red btn-sm" onclick="closeModal('manualDurationModal')">X</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Enter Duration (e.g., "3 weeks", "Since yesterday")</label>
                    <input type="text" id="manualDurationInput" class="form-control" placeholder="Type here..." onkeydown="if(event.key==='Enter') saveManualDuration()">
                </div>
                <button class="btn btn-primary" style="width:100%" onclick="saveManualDuration()">OK</button>
            </div>
        </div>
    </div>

    <div id="universalMedModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header">
                <h4 class="modal-title" id="uniModalTitle">Add New Medicine</h4>
                <button class="btn btn-red btn-sm" onclick="closeModal('universalMedModal')">X</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="uniModalMode"> 
                <input type="hidden" id="uniModalTargetId"> 
                
                <div class="form-group">
                    <label>Medicine Name</label>
                    <input type="text" id="uniModalName" placeholder="e.g. Paracetamol">
                </div>
                <div class="form-group">
                    <label>Strengths (comma separated)</label>
                    <input type="text" id="uniModalStrengths" placeholder="e.g. 500mg, 650mg">
                </div>
                <button class="btn btn-green" style="width:100%" onclick="saveUniversalMedicine()">Save to Database</button>
            </div>
        </div>
    </div>

    <div id="templateManagerModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h4 class="modal-title">Manage Clinical Templates</h4>
                <button class="btn btn-red btn-sm" onclick="closeModal('templateManagerModal')">X</button>
            </div>
            <div class="modal-body">
                <div style="background:var(--bg); padding:20px; border-radius:var(--radius-md); margin-bottom:20px; border:1px solid var(--border);">
                    <h5 style="margin-top:0;">Add New Template</h5>
                    <div class="form-group"><label>Condition Name (e.g. Headache)</label><input type="text" id="tplName"></div>
                    <div class="form-group"><label>Sub-Types (comma separated)</label><input type="text" id="tplTypes" placeholder="Migraine, Tension, Cluster"></div>
                    <div class="form-group"><label>Durations (comma separated)</label><input type="text" id="tplDurations" placeholder="5 Days, 10 Days, 1 Month"></div>
                    <button class="btn btn-green" onclick="saveNewTemplate()">Save Template</button>
                </div>
                <div id="templateListContainer"><div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border);"><span>Vertigo</span><button class="btn btn-red btn-sm" onclick="deleteTemplate('G2WDPhElj5BAmceimytG')">Del</button></div><div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border);"><span>Stroke</span><button class="btn btn-red btn-sm" onclick="deleteTemplate('JTHLQkhNg2ufZ0KDOYNb')">Del</button></div></div>
            </div>
        </div>
    </div>

    <div id="authContainer" style="display: none;">
        <div class="auth-card">
            <div class="auth-title">Dr. Bharat's Arogya</div>
            <div class="auth-subtitle">Secure Cloud System Access</div>
            
            <div id="loginForm">
                <div class="form-group"><label>Email Address</label><input type="email" id="loginEmail" placeholder="e.g. doctor@clinic.com"></div>
                <div class="form-group"><label>Password</label><input type="password" id="loginPass" placeholder="Enter Password"></div>
                <button class="btn btn-primary" style="width:100%" onclick="login()">Login</button>
                <div style="margin-top:20px; font-size:13px;"><a href="#" style="color:var(--primary); text-decoration:none; font-weight:600;" onclick="toggleAuthForms()">Register New Staff</a></div>
            </div>

            <div id="signupForm" style="display:none;">
                <div class="form-group"><label>Email Address</label><input type="email" id="regEmail" placeholder="e.g. nurse@clinic.com"></div>
                <div class="form-group"><label>Create Password</label><input type="password" id="regPass" placeholder="Min 6 characters"></div>
                <div class="form-group"><label>Clinic Code</label><input type="password" id="regCode" placeholder="Ask Administrator" style="border-color:var(--warning);"></div>
                <button class="btn btn-green" style="width:100%" onclick="signup()">Register</button>
                <div style="margin-top:20px; font-size:13px;"><a href="#" style="color:var(--primary); text-decoration:none; font-weight:600;" onclick="toggleAuthForms()">Back to Login</a></div>
            </div>
        </div>
    </div>

    <div id="appContainer" style="display: block;">
        <div class="container">
            <div class="app-header no-print">
                <div class="header-left">
                    <h1>Dr. bharat's arogya Homeopathy</h1>
                </div>
                <div class="header-right">
                    <div class="nav-pills">
                        <button id="btn-reception" class="nav-btn active">Reception Desk</button>
                        <button id="btn-doctor" class="nav-btn">Doctor Chamber</button>
                        <button id="btn-medicines" class="nav-btn" onclick="openManagerAddModal()">Add Medicine</button>
                        <button id="btn-logout" class="nav-btn logout-btn" onclick="logout()">Logout</button>
                    </div>
                </div>
            </div>

            <div id="receptionPage" class="page active no-print">
                <div class="grid-reception">
                    <div class="card">
                        <h3 style="margin-top:0; color:var(--text);">New Patient Registration</h3>
                        <form id="regForm">
                            <div class="grid-3-top">
                                <div class="form-group"><label>Patient Name *</label><input type="text" id="regName" required=""></div>
                                <div class="form-group"><label>Age *</label><input type="number" id="regAge" placeholder="Years" required=""></div>
                                <div class="form-group"><label>Sex *</label><select id="regSex" required=""><option value="">Select</option><option value="Male">Male</option><option value="Female">Female</option><option value="Other">Other</option></select></div>
                            </div>
                            <div class="form-group"><label>Phone Number</label><input type="tel" id="regPhone"></div>
                            <div class="form-group"><label>Address</label><input type="text" id="regAddress"></div>
                            <div class="form-group"><label>Provisional Diagnosis</label><textarea id="regDiagnosis" rows="2" class="auto-expand"></textarea></div>
                            <button type="submit" id="btnRegister" class="btn btn-primary">Register Patient</button>
                        </form>
                    </div>
                    
                    <div class="card" style="height: fit-content;">
                        <h3 style="margin-top:0; color:var(--primary);">Review / Old Patient</h3>
                        <div class="mic-wrapper" style="margin-bottom:16px;"><input type="text" id="reviewSearch" placeholder="üîç Search Database..."><button id="mic-reviewSearch" class="mic-btn" onmousedown="handleManualMicClick(event, 'reviewSearch')"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg></button></div>
                        <div id="reviewList" style="height: 400px; overflow-y: auto; border:1px solid var(--border); border-radius:var(--radius-md); padding:10px;">
                <div class="patient-list-item review-item" onclick="togglePatientDetails(this)">
                    <div class="patient-list-header">
                        <div><strong>prajwal rawoot</strong> <small style="color:var(--text-light)">(#1 | 19Y/Male)</small></div>
                        <button class="btn btn-yellow btn-sm" onclick="event.stopPropagation(); sendToDoctor('FHWN3TEKVjYZI08dEvyn')">Send to Doctor</button>
                    </div>
                    <div class="patient-details-expanded">
                        <div style="font-size:13px; margin-bottom:4px;">üìû 8088361612</div>
                        <div style="font-size:13px;">üè† piranwadi</div>
                    </div>
                </div></div>
                    </div>
                </div>
            </div>

            <div id="medicinePage" class="page no-print">
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:20px;">
                        <h3 style="margin:0;">üíä Medicine Manager (Cloud)</h3>
                        <button class="btn btn-primary" onclick="openManagerAddModal()">+ Add New Medicine</button>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div class="mic-wrapper"><input type="text" id="medManagerSearch" placeholder="üîç Search medicines..." oninput="renderMedManagerList()"></div>
                    </div>
                    <div id="medManagerList" style="height: 500px; overflow-y: auto; border:1px solid var(--border); border-radius:var(--radius-md);">
                    <div class="med-list-item">
                        <div><strong>Duloxetine</strong> <br> <small style="color:var(--text-light)">sss, ssss, bbb, 5767</small></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary btn-sm" onclick="openManagerEditModal('gJC9NHSuAhGO395XeGCX', 'Duloxetine', 'sss, ssss, bbb, 5767')">Edit</button>
                            <button class="btn btn-red btn-sm" onclick="deleteMedicine('gJC9NHSuAhGO395XeGCX')">Delete</button>
                        </div>
                    </div>
                    <div class="med-list-item">
                        <div><strong>Syndopa</strong> <br> <small style="color:var(--text-light)">45</small></div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-secondary btn-sm" onclick="openManagerEditModal('qwyrphgSNgcnJK1C1tvZ', 'Syndopa', '45')">Edit</button>
                            <button class="btn btn-red btn-sm" onclick="deleteMedicine('qwyrphgSNgcnJK1C1tvZ')">Delete</button>
                        </div>
                    </div></div>
                </div>
            </div>

            <div id="doctorPage" class="page no-print">
                <div class="grid-doctor">
                    <div class="card patient-list-section">
                        <div style="margin-bottom:16px; padding-bottom:10px; border-bottom:1px solid var(--border);"><h3 style="margin:0; font-size:18px;">Waiting Queue (<span id="queueCount">1</span>)</h3></div>
                        <div id="doctorQueueList" style="flex-grow:1;"><div class="patient-list-item "><strong>prajwal rawoot</strong><br><small>#1 | 19Y / Male</small></div></div>
                    </div>

                    <div id="workspace" style="display: none;">
                        <div class="card">
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:15px; margin-bottom:24px;">
                                <div><h2 id="pNameDisplay" style="margin:0; font-weight:800;">-</h2><small id="pDetailsDisplay" style="color:var(--text-light); font-weight:500;">-</small></div>
                                <div style="display:flex; gap:16px; align-items:center;">
                                    <div class="auto-mic-container"><span class="switch-label">Auto-Mic</span><label class="switch"><input type="checkbox" id="autoMicToggle" onchange="toggleAutoMic()"><span class="slider"></span></label></div>
                                    <button id="btnToggleHistory" class="btn btn-secondary">Patient History</button>
                                </div>
                            </div>

                            <div id="historySection" style="display:none; background:var(--primary-light); padding:20px; border-radius:var(--radius-lg); margin-bottom:24px; border:1px solid #bfdbfe;">
                                <h4 style="margin-top:0; color:var(--primary);">Previous Visits</h4>
                                <div id="historyContent">Loading history...</div>
                            </div>

                            <div style="margin-bottom: 24px; background: var(--bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                                <h5 style="margin-top:0; color:var(--primary); margin-bottom:16px; font-size:15px;">On Examination</h5>
                                <div class="lab-grid-row1">
                                    <div class="form-group"><label>BP</label><input type="text" id="examBP" class="lab-input" placeholder="e.g. 140/80"></div>
                                    <div class="form-group"><label>Pulse</label><input type="text" id="examPulse" class="lab-input" placeholder="e.g. 78"></div>
                                </div>
                                <div class="lab-grid-row2">
                                    <div class="form-group"><label>HB (g/dL)</label><input type="text" id="labHB" class="lab-input" placeholder="e.g. 12.5"></div>
                                    <div class="form-group"><label>RBS (mg/dL)</label><input type="text" id="labRBS" class="lab-input" placeholder="e.g. 110"></div>
                                    <div class="form-group"><label>Creatinine (mg/dL)</label><input type="text" id="labCreatinine" class="lab-input" placeholder="e.g. 0.9"></div>
                                </div>
                                <div class="form-group"><label>ECG</label><textarea id="testECG" class="auto-expand" rows="1" placeholder="Result"></textarea></div>
                                <div class="form-group"><label>EEG</label><textarea id="testEEG" class="auto-expand" rows="1" placeholder="Result"></textarea></div>
                                <div class="form-group"><label>NCV</label><textarea id="testNCV" class="auto-expand" rows="1" placeholder="Result"></textarea></div>
                                <div class="form-group"><label>Carotid Doppler / TCS</label><textarea id="testDoppler" class="auto-expand" rows="1" placeholder="Result"></textarea></div>
                            </div>

                            <div style="margin-bottom: 24px; background: var(--bg); padding: 20px; border-radius: var(--radius-lg); border: 1px solid var(--border);">
                                <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <input type="checkbox" id="includeNotesInPrint" style="width:16px; height:16px; cursor:pointer; margin:0;" title="Check to print on Rx">
                                        <label for="includeNotesInPrint" style="font-weight:700; color:var(--text); font-size:14px; cursor:pointer; margin:0;">Case Details / Notes (Check to print)</label>
                                    </div>
                                    <div class="template-area" id="templateChipContainer"></div>
                                </div>
                                <div class="mic-wrapper">
                                    <textarea id="docDetails" class="auto-expand" rows="4" placeholder="Type or use templates..."></textarea>
                                    <button id="mic-docDetails" class="mic-btn" onmousedown="handleManualMicClick(event, 'docDetails')"><svg viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path><path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"></path></svg></button>
                                </div>
                            </div>

                            <div id="drugListContainer"></div>
                            <div style="margin-top:20px;"><button id="btnAddDrug" class="btn btn-secondary">+ Add Medicine</button></div>
                            
                            <div style="margin-top: 32px; display:flex; justify-content:space-between; border-top:1px solid var(--border); padding-top:24px;">
                                <button id="btnFinish" class="btn btn-red">Clear from Queue</button>
                                <button id="btnPrint" class="btn btn-primary">Save &amp; Print Prescription</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="print-only print-container">
        
        <div id="printPage1" class="print-page" style="display:none;">
            <div class="print-header">
                <div class="dr-info"><h1>Dr. bharat's arogya Homeopathy</h1></div>
                <div class="clinic-info-container"></div>
            </div>
            
            <div class="print-meta-grid">
                <div id="printNameP1"></div>
                <div id="printRegP1"></div>
                <div id="printAgeSexP1"></div>
            </div>
            
            <div id="printExamBody"></div>
            <div id="printNotesBody" class="print-details-box" style="margin-top:10px;"></div>
        </div>

        <div id="printPage2" class="print-page page-break-before" style="display:none;">
            <div class="print-header">
                <div class="dr-info"><h1>Dr. bharat's arogya Homeopathy</h1></div>
                <div class="clinic-info-container"></div>
            </div>

            <div class="print-meta-grid">
                <div id="printNameP2"></div>
                <div id="printRegP2"></div>
                <div id="printDateP2"></div>
            </div>

            <div class="rx-badge"><span>PRESCRIPTION</span></div>

            <table class="rx-table"><thead><tr><th width="5%">Sl.<br>No.</th><th width="40%">DRUG NAME</th><th width="10%">Morning<br><span class="lang-sub">‡≤¨‡≥Ü‡≤≥‡≤ø‡≤ó‡≥ç‡≤ó‡≥Ü / ‡§∏‡§ï‡§æ‡§≥‡•Ä</span></th><th width="10%">Afternoon<br><span class="lang-sub">‡≤Æ‡≤ß‡≥ç‡≤Ø‡≤æ‡≤π‡≥ç‡≤® / ‡§¶‡•Å‡§™‡§æ‡§∞‡•Ä</span></th><th width="10%">Night<br><span class="lang-sub">‡≤∞‡≤æ‡≤§‡≥ç‡≤∞‡≤ø / ‡§∞‡§æ‡§§‡•ç‡§∞‡•Ä</span></th><th width="10%">Total Qty.</th></tr></thead><tbody id="printTableBody"></tbody></table>
            
            <div class="print-footer"><div class="signature-line">Signature</div></div>
        </div>

    </div>

    <datalist id="allMedicines"><option value="Duloxetine"></option><option value="Syndopa"></option></datalist>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, arrayUnion, serverTimestamp, getDocs, deleteDoc, runTransaction } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAlDYY4VvvK36DbdDkCmrt2CzCncNlqPsc",
          authDomain: "mama-doc.firebaseapp.com",
          projectId: "mama-doc",
          storageBucket: "mama-doc.firebasestorage.app",
          messagingSenderId: "379716157515",
          appId: "1:379716157515:web:f6d5d32f8b493168648dce",
          measurementId: "G-HBJX2783EC"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const CLINIC_CODE = "NEURO2026"; 

        const DEFAULT_TEMPLATES = [
            { name: "Headache", subtypes: ["Migraine", "Tension", "Cluster", "Sinusitis"], durations: ["5 Days", "10 Days", "15 Days", "1 Month"] },
            { name: "Epilepsy", subtypes: ["GTCS", "Focal", "Absence", "Myoclonic"], durations: ["1 Month", "2 Months", "3 Months", "6 Months"] },
            { name: "Vertigo", subtypes: ["BPPV", "Meniere's", "Vestibular Neuritis"], durations: ["3 Days", "5 Days", "1 Week", "2 Weeks"] },
            { name: "Stroke", subtypes: ["Ischemic", "Hemorrhagic", "TIA"], durations: ["Acute", "1 Month", "Long Term"] },
            { name: "Back Pain", subtypes: ["Lumbar Spondylosis", "Disc Prolapse", "Sciatica"], durations: ["5 Days", "10 Days", "15 Days", "1 Month"] },
            { name: "Neck Pain", subtypes: ["Cervical Spondylosis", "Muscle Spasm"], durations: ["5 Days", "10 Days", "15 Days"] },
            { name: "Neuropathy", subtypes: ["Diabetic", "Peripheral", "Vitamin Deficiency"], durations: ["1 Month", "2 Months", "3 Months"] },
            { name: "Parkinson's", subtypes: ["Tremor Dominant", "Rigidity Dominant"], durations: ["1 Month", "3 Months"] }
        ];

        let allPatients = [], waitingQueue = [], cloudMedicines = [], clinicalTemplates = [];
        let currentPatient = null, rowCount = 0;
        let recognition = null, isAutoMicOn = false, activeInputId = null, finalTranscript = '';
        let currentTemplateAction = null;

        function showToast(msg, type='neutral') {
            const t = document.getElementById('toast');
            t.className = type; 
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => { t.className = ''; }, 800); 
        }

        window.togglePatientDetails = function(el) { el.classList.toggle('expanded'); }

        onAuthStateChanged(auth, (user) => {
            document.getElementById('loadingOverlay').style.display = 'none';
            if (user) {
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                initApp();
            } else {
                document.getElementById('authContainer').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
            }
        });

        window.login = async () => {
            const email = document.getElementById('loginEmail').value, pass = document.getElementById('loginPass').value;
            if(!email || !pass) return showToast("Enter credentials", "error");
            document.getElementById('loadingOverlay').style.display = 'flex';
            try { await signInWithEmailAndPassword(auth, email, pass); } catch(e) { showToast(e.message, "error"); document.getElementById('loadingOverlay').style.display = 'none'; }
        };

        window.signup = async () => {
            const email = document.getElementById('regEmail').value, pass = document.getElementById('regPass').value, code = document.getElementById('regCode').value;
            if(code !== CLINIC_CODE) return showToast("Wrong Code", "error");
            document.getElementById('loadingOverlay').style.display = 'flex';
            try { await createUserWithEmailAndPassword(auth, email, pass); } catch(e) { showToast(e.message, "error"); document.getElementById('loadingOverlay').style.display = 'none'; }
        };

        window.logout = () => { document.getElementById('loadingOverlay').style.display = 'flex'; signOut(auth); };
        window.toggleAuthForms = () => {
            const l = document.getElementById('loginForm'), s = document.getElementById('signupForm');
            if(l.style.display==='none'){l.style.display='block';s.style.display='none'}else{l.style.display='none';s.style.display='block'}
        };

        async function initApp() {
            setupListeners();
            await seedMedicines();
            await seedTemplates();
            
            onSnapshot(query(collection(db, "patients"), orderBy("timestamp", "desc")), (s) => {
                allPatients = s.docs.map(d => ({ id: d.id, ...d.data() }));
                waitingQueue = allPatients.filter(p => p.status === 'waiting');
                renderDoctorQueue(); renderReviewSearch();
            });
            onSnapshot(query(collection(db, "medicines"), orderBy("name")), (s) => {
                cloudMedicines = s.docs.map(d => ({ id: d.id, ...d.data() }));
                populateDatalist(); renderMedManagerList();
            });
            onSnapshot(collection(db, "clinicalTemplates"), (s) => {
                clinicalTemplates = s.docs.map(d => ({ id: d.id, ...d.data() }));
                renderTemplateChips(); renderTemplateManagerList();
            });
            ['docDetails'].forEach(attachMicListeners);
            
            document.querySelectorAll('.auto-expand').forEach(el => {
                el.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                });
            });
            
            document.getElementById('includeNotesInPrint').checked = true;
            
            const bpInput = document.getElementById('examBP');
            bpInput.addEventListener('input', function(e) {
                if(this.value.length === 3 && !this.value.includes('/')) {
                    this.value += '/';
                }
            });
        }

        async function seedMedicines() { const snap = await getDocs(collection(db, "medicines")); if(snap.empty && typeof medicineDatabase !== 'undefined') for (const [n, s] of Object.entries(medicineDatabase)) await addDoc(collection(db, "medicines"), { name: n, strengths: s }); }
        async function seedTemplates() { const snap = await getDocs(collection(db, "clinicalTemplates")); if(snap.empty) for(const t of DEFAULT_TEMPLATES) await addDoc(collection(db, "clinicalTemplates"), t); }

        function handleMedicineInput(rid) {
            const input = document.getElementById(`name-${rid}`);
            const nameVal = input.value.trim();
            const missingDiv = document.getElementById(`missing-alert-${rid}`);
            const med = cloudMedicines.find(m => m.name.toLowerCase() === nameVal.toLowerCase());
            
            const select = document.getElementById(`str-select-${rid}`);
            select.innerHTML = '<option value="">--</option>'; 

            if (med) {
                missingDiv.innerHTML = '';
                med.strengths.forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt; el.innerText = opt;
                    select.appendChild(el);
                });
                const manualOpt = document.createElement('option');
                manualOpt.value = 'manual'; manualOpt.innerText = '‚úé Manual Input';
                select.appendChild(manualOpt);
                toggleStrengthMode(rid, 'select');
                
            } else if (nameVal.length > 2) {
                const manualOpt = document.createElement('option');
                manualOpt.value = 'manual'; manualOpt.innerText = '‚úé Manual Input';
                select.appendChild(manualOpt);
                missingDiv.innerHTML = `<span class="add-med-btn-inline" onclick="openAddRowModal('${rid}', '${nameVal}')">+ Add "${nameVal}"</span>`;
            } else { 
                missingDiv.innerHTML = ''; 
                toggleStrengthMode(rid, 'select');
            }
        }

        window.toggleStrengthMode = (rid, mode) => {
            const select = document.getElementById(`str-select-${rid}`);
            const manualBox = document.getElementById(`str-manual-box-${rid}`);
            
            if (mode === 'manual') {
                select.style.display = 'none';
                manualBox.style.display = 'flex';
                document.getElementById(`str-input-${rid}`).focus();
            } else {
                select.style.display = 'block';
                select.value = ''; 
                manualBox.style.display = 'none';
            }
        };

        window.handleStrengthChange = (rid) => {
            const select = document.getElementById(`str-select-${rid}`);
            if (select.value === 'manual') {
                toggleStrengthMode(rid, 'manual');
            }
        };

        window.openAddRowModal = (rid, name) => {
            document.getElementById('uniModalTitle').innerText = "Add Missing Medicine";
            document.getElementById('uniModalName').value = name;
            document.getElementById('uniModalStrengths').value = '';
            document.getElementById('uniModalMode').value = 'row';
            document.getElementById('uniModalTargetId').value = rid;
            document.getElementById('universalMedModal').style.display = 'flex';
        };

        window.openManagerAddModal = () => {
            document.getElementById('uniModalTitle').innerText = "Add New Medicine";
            document.getElementById('uniModalName').value = '';
            document.getElementById('uniModalStrengths').value = '';
            document.getElementById('uniModalMode').value = 'manager_add';
            document.getElementById('universalMedModal').style.display = 'flex';
        };

        window.openManagerEditModal = (id, name, strengthsStr) => {
            document.getElementById('uniModalTitle').innerText = "Edit Medicine";
            document.getElementById('uniModalName').value = name;
            document.getElementById('uniModalStrengths').value = strengthsStr;
            document.getElementById('uniModalMode').value = 'manager_edit';
            document.getElementById('uniModalTargetId').value = id;
            document.getElementById('universalMedModal').style.display = 'flex';
        };

        window.saveUniversalMedicine = async () => {
            const name = document.getElementById('uniModalName').value;
            const strStr = document.getElementById('uniModalStrengths').value;
            const mode = document.getElementById('uniModalMode').value;
            const targetId = document.getElementById('uniModalTargetId').value;
            
            if(!name) return showToast("Enter Medicine Name", "error");
            const strengths = strStr.split(',').map(s => s.trim()).filter(s => s);
            
            if (mode === 'manager_edit') {
                await updateDoc(doc(db, "medicines", targetId), { name, strengths });
            } else {
                await addDoc(collection(db, "medicines"), { name, strengths });
            }
            
            if (mode === 'row') {
                const select = document.getElementById(`str-select-${targetId}`);
                select.innerHTML = '<option value="">--</option>';
                strengths.forEach(opt => {
                    const el = document.createElement('option'); el.value = opt; el.innerText = opt; select.appendChild(el);
                });
                const man = document.createElement('option'); man.value = 'manual'; man.innerText = '‚úé Manual Input'; select.appendChild(man);
                document.getElementById(`missing-alert-${targetId}`).innerHTML = '';
            }
            
            closeModal('universalMedModal');
            showToast("Medicine Saved!", "success");
        };

        window.deleteMedicine = async function(id) { if(confirm("Delete?")) await deleteDoc(doc(db, "medicines", id)); }
        window.quickAddMedicine = function(name) { switchPage('medicine'); showAddMedForm(); document.getElementById('newMedName').value = name; }
        
        function renderMedManagerList() {
            const term = document.getElementById('medManagerSearch').value.toLowerCase();
            const container = document.getElementById('medManagerList'); container.innerHTML = "";
            cloudMedicines.filter(m => m.name.toLowerCase().includes(term)).forEach(m => {
                container.innerHTML += `
                    <div class="med-list-item">
                        <div><strong>${m.name}</strong> <br> <small style="color:var(--text-light)">${m.strengths.join(', ')}</small></div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn btn-secondary btn-sm" onclick="openManagerEditModal('${m.id}', '${m.name}', '${m.strengths.join(", ")}')">Edit</button>
                            <button class="btn btn-red btn-sm" onclick="deleteMedicine('${m.id}')">Delete</button>
                        </div>
                    </div>`;
            });
        }
        
        function populateDatalist() { const dl = document.getElementById('allMedicines'); dl.innerHTML = ""; cloudMedicines.forEach(med => { const opt = document.createElement('option'); opt.value = med.name; dl.appendChild(opt); }); }

        function setupListeners() {
            document.getElementById('btn-reception').onclick = () => switchPage('reception');
            document.getElementById('btn-doctor').onclick = () => switchPage('doctor');
            document.getElementById('btn-medicines').onclick = () => switchPage('medicine');
            document.getElementById('regForm').onsubmit = async (e) => { e.preventDefault(); await registerPatient(); };
            document.getElementById('btnAddDrug').onclick = addDrugRow;
            document.getElementById('btnFinish').onclick = finishConsultation;
            document.getElementById('btnPrint').onclick = saveAndPrint;
            document.getElementById('reviewSearch').onkeyup = renderReviewSearch;
            document.getElementById('btnToggleHistory').onclick = toggleHistory;
        }
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            if(page === 'reception') document.getElementById('btn-reception').classList.add('active');
            else if(page === 'doctor') document.getElementById('btn-doctor').classList.add('active');
            else if(page === 'medicine') document.getElementById('btn-medicines').classList.add('active');
        }

        async function registerPatient() {
            const btn = document.getElementById('btnRegister'); btn.disabled = true;
            const counterRef = doc(db, "counters", "patients");
            try {
                await runTransaction(db, async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    let newId = 1;
                    if (counterDoc.exists()) { newId = counterDoc.data().current + 1; }
                    transaction.set(counterRef, { current: newId });
                    const newPatientRef = doc(collection(db, "patients"));
                    transaction.set(newPatientRef, {
                        name: document.getElementById('regName').value, 
                        age: document.getElementById('regAge').value, 
                        sex: document.getElementById('regSex').value,
                        phone: document.getElementById('regPhone').value, 
                        address: document.getElementById('regAddress').value, 
                        diagnosis: document.getElementById('regDiagnosis').value,
                        regDate: new Date().toLocaleDateString(), 
                        timestamp: serverTimestamp(), 
                        status: 'waiting', 
                        history: [],
                        regNo: newId
                    });
                });
                document.getElementById('regForm').reset();
                showToast("Patient Registered!", "success");
            } catch (e) { console.error(e); showToast("Registration Failed", "error"); }
            btn.disabled = false;
        }

        function renderReviewSearch() {
            const term = document.getElementById('reviewSearch').value.toLowerCase(), container = document.getElementById('reviewList'); container.innerHTML = "";
            allPatients.filter(p => p.name.toLowerCase().includes(term) || String(p.regNo).includes(term)).forEach(p => {
                container.innerHTML += `
                <div class="patient-list-item review-item" onclick="togglePatientDetails(this)">
                    <div class="patient-list-header">
                        <div><strong>${p.name}</strong> <small>(#${p.regNo || '?'} | ${p.age}Y/${p.sex})</small></div>
                        <button class="btn btn-yellow btn-sm" onclick="event.stopPropagation(); sendToDoctor('${p.id}')">Send to Doctor</button>
                    </div>
                    <div class="patient-details-expanded">
                        <div style="font-size:12px; margin-bottom:2px;">üìû ${p.phone || '-'}</div>
                        <div style="font-size:12px;">üè† ${p.address || '-'}</div>
                    </div>
                </div>`;
            });
        }
        window.sendToDoctor = async (id) => { await updateDoc(doc(db, "patients", id), { status: 'waiting', timestamp: serverTimestamp() }); showToast("Sent to Doctor", "success"); };
        function renderDoctorQueue() {
            const container = document.getElementById('doctorQueueList'); container.innerHTML = ""; document.getElementById('queueCount').innerText = waitingQueue.length;
            waitingQueue.forEach(p => {
                const div = document.createElement('div'); div.className = `patient-list-item ${currentPatient && currentPatient.id === p.id ? 'selected' : ''}`;
                div.onclick = () => selectPatient(p); div.innerHTML = `<strong>${p.name}</strong><br><small>#${p.regNo || '?'} | ${p.age}Y / ${p.sex}</small>`;
                container.appendChild(div);
            });
        }
        function selectPatient(p) {
            currentPatient = p; document.getElementById('workspace').style.display = 'block';
            document.getElementById('pNameDisplay').innerText = p.name; document.getElementById('pDetailsDisplay').innerText = `#${p.regNo || '?'} | ${p.age}Y / ${p.sex} | ${p.phone}`;
            renderDoctorQueue(); document.getElementById('drugListContainer').innerHTML = ''; document.getElementById('docDetails').value = ''; 
            ['examBP','examPulse','labHB','labRBS','labCreatinine','testECG','testEEG','testNCV','testDoppler'].forEach(id => document.getElementById(id).value = '');
            addDrugRow();
        }

        async function saveAndPrint() {
            if(!currentPatient) return;
            const btn = document.getElementById('btnPrint'), notes = document.getElementById('docDetails').value, printNotes = document.getElementById('includeNotesInPrint').checked;
            document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
            if(printNotes && !notes.trim()) { showToast("Notes are empty!", "error"); document.getElementById('docDetails').classList.add('input-error'); return; }
            
            const drugs = []; let isValid = true;
            
            const rows = document.querySelectorAll('.drug-row');
            for(const row of rows) {
                const rid = row.id.split('-')[1];
                const name = document.getElementById(`name-${rid}`).value.trim();
                if(!name) continue;

                const type = document.querySelector(`input[id^="type-"][id$="-${rid}"]:checked`)?.id.split('-')[1].toUpperCase();
                if(!type) { isValid = false; showToast("Select Type for " + name, "error"); row.scrollIntoView(); return; }
                
                const sel = document.getElementById(`str-select-${rid}`);
                const inp = document.getElementById(`str-input-${rid}`);
                let str = (sel.style.display !== 'none') ? sel.value : inp.value;
                if(!str && sel.style.display !== 'none') { isValid = false; showToast("Select Strength for " + name, "error"); return; }
                
                const getVal = (s) => document.getElementById(`${s}-chk-${rid}`).checked ? 1 : parseFloat(document.getElementById(`${s}-${rid}`).value);
                const m=getVal('m'), a=getVal('a'), n=getVal('n');
                if(m+a+n === 0) { isValid = false; showToast("Select Dose for " + name, "error"); return; }
                const total = document.getElementById(`t-${rid}`).value;
                if(total == 0 || total === "Error") { isValid = false; showToast("Check duration for " + name, "error"); return; }
                
                drugs.push({ name, strength: str, type, m, a, n, t: total });

                const existingMed = cloudMedicines.find(m => m.name.toLowerCase() === name.toLowerCase());
                if(!existingMed) {
                    await addDoc(collection(db, "medicines"), { name: name, strengths: [str] });
                } else if(str && !existingMed.strengths.includes(str)) {
                    await updateDoc(doc(db, "medicines", existingMed.id), { strengths: arrayUnion(str) });
                }
            }

            if(!isValid) return; if(drugs.length === 0 && !notes) { showToast("Nothing to print!", "error"); return; }

            const labs = {
                bp: document.getElementById('examBP').value, pulse: document.getElementById('examPulse').value,
                hb: document.getElementById('labHB').value, rbs: document.getElementById('labRBS').value, cr: document.getElementById('labCreatinine').value,
                ecg: document.getElementById('testECG').value, eeg: document.getElementById('testEEG').value, ncv: document.getElementById('testNCV').value, dop: document.getElementById('testDoppler').value
            };

            btn.disabled = true;
            try {
                const record = { date: new Date().toLocaleDateString(), meds: drugs, notes, labs };
                await updateDoc(doc(db, "patients", currentPatient.id), { history: arrayUnion(record) });
                
                const hasExam = (printNotes && notes) || labs.bp || labs.pulse || labs.hb || labs.rbs || labs.cr || labs.ecg || labs.eeg || labs.ncv || labs.dop;
                const hasMeds = drugs.length > 0;

                const page1 = document.getElementById('printPage1');
                if(hasExam) {
                    page1.style.display = 'block';
                    document.getElementById('printNameP1').innerText = "Patient Name: " + currentPatient.name;
                    document.getElementById('printRegP1').innerText = "Reg No: " + (currentPatient.regNo || '-');
                    document.getElementById('printAgeSexP1').innerText = `Age/Sex: ${currentPatient.age} / ${currentPatient.sex}`;
                    
                    let examHtml = "";
                    if(labs.bp || labs.pulse) examHtml += `<div class="print-section-box"><div class="print-section-title">On Examination:</div><div class="print-section-content">BP: ${labs.bp||'-'} &nbsp;&nbsp; Pulse: ${labs.pulse||'-'}</div></div>`;
                    if(labs.hb || labs.rbs || labs.cr) examHtml += `<div class="print-section-box"><div class="print-section-title">Blood Test:</div><div class="print-section-content">HB: ${labs.hb||'-'} &nbsp;&nbsp; RBS: ${labs.rbs||'-'} &nbsp;&nbsp; Cr: ${labs.cr||'-'}</div></div>`;
                    if(labs.ecg) examHtml += `<div class="print-section-box"><div class="print-section-title">ECG:</div><div class="print-section-content">${labs.ecg}</div></div>`;
                    if(labs.eeg) examHtml += `<div class="print-section-box"><div class="print-section-title">EEG:</div><div class="print-section-content">${labs.eeg}</div></div>`;
                    if(labs.ncv) examHtml += `<div class="print-section-box"><div class="print-section-title">NCV:</div><div class="print-section-content">${labs.ncv}</div></div>`;
                    if(labs.dop) examHtml += `<div class="print-section-box"><div class="print-section-title">Carotid/TCS:</div><div class="print-section-content">${labs.dop}</div></div>`;
                    document.getElementById('printExamBody').innerHTML = examHtml;

                    const pNotes = document.getElementById('printNotesBody');
                    if(printNotes && notes) { pNotes.innerHTML = "<strong>Case Details:</strong><br>" + notes; pNotes.style.display = 'block'; } 
                    else pNotes.style.display = 'none';
                } else {
                    page1.style.display = 'none';
                }

                const page2 = document.getElementById('printPage2');
                if(hasMeds) {
                    page2.style.display = 'flex';
                    document.getElementById('printNameP2').innerText = "Name: " + currentPatient.name;
                    document.getElementById('printRegP2').innerText = "Reg No: " + (currentPatient.regNo || '-');
                    document.getElementById('printDateP2').innerText = "Date: " + record.date;
                    
                    const tbody = document.getElementById('printTableBody'); tbody.innerHTML = '';
                    drugs.forEach((d, i) => {
                        const fmt = (v) => v==0.5 ? '¬Ω' : v;
                        tbody.innerHTML += `<tr><td>${i+1}</td><td class="drug-name-cell">${d.type} ${d.name} <small>${d.strength}</small></td><td>${fmt(d.m)}</td><td>${fmt(d.a)}</td><td>${fmt(d.n)}</td><td>${d.t}</td></tr>`;
                    });
                } else {
                    page2.style.display = 'none';
                }

                window.print();
            } catch(e) { console.log(e); showToast("Error!", "error"); } finally { btn.disabled = false; }
        }

        async function finishConsultation() {
            if(!currentPatient) return;
            await updateDoc(doc(db, "patients", currentPatient.id), { status: 'done' });
            showToast("Cleared from Queue", "success");
            document.getElementById('workspace').style.display = 'none'; currentPatient = null;
        }

        window.addDrugRow = addDrugRow;
        window.calculateTotal = calculateTotal;
        window.updateStrengths = (id) => handleMedicineInput(id);
        window.handleTypeCheck = (rid, type) => { ['tab','syp','cap'].forEach(t => { if(t!==type) document.getElementById(`type-${t}-${rid}`).checked=false; }); };
        window.handleDoseInput = (rid, slot, src) => { 
            const d=document.getElementById(`${slot}-${rid}`), c=document.getElementById(`${slot}-chk-${rid}`);
            if(src==='dropdown') { if(d.value!=='0') c.checked=false; } else if(c.checked) d.value='0';
            calculateTotal(rid);
        };
        window.handleDurationChange = (rid) => { 
            document.getElementById(`d-manual-container-${rid}`).style.display = (document.getElementById(`d-preset-${rid}`).value==='manual') ? 'flex' : 'none';
            calculateTotal(rid);
        };
        
        window.setDurationChk = (rid, days) => {
            [5, 10, 15, 30].forEach(d => {
                const box = document.getElementById(`d-${d}-${rid}`);
                if(d !== days) box.checked = false;
            });
            document.getElementById(`d-preset-${rid}`).value = "manual";
            document.getElementById(`d-manual-container-${rid}`).style.display = 'flex';
            document.getElementById(`d-num-${rid}`).value = days;
            document.getElementById(`d-unit-${rid}`).value = "1"; 
            calculateTotal(rid);
        };

        function toggleHistory() {
            const sec = document.getElementById('historySection'), cont = document.getElementById('historyContent');
            if (sec.style.display === 'none') {
                sec.style.display = 'block';
                if (!currentPatient.history?.length) {
                    cont.innerHTML = "No history.";
                } else {
                    cont.innerHTML = currentPatient.history.slice().reverse().map(h => {
                        let labStr = "";
                        if (h.labs) {
                            const l = h.labs;
                            const parts = [];
                            if(l.bp) parts.push(`BP: ${l.bp}`);
                            if(l.hb) parts.push(`HB: ${l.hb}`);
                            if(parts.length > 0) labStr = `<div style="font-size:12px; color:var(--text-light); margin-bottom:5px;"><strong>Exam:</strong> ${parts.join(', ')}</div>`;
                        }
                        return `<div style="border-bottom:1px solid var(--border); padding:10px 0;"><strong>${h.date}</strong>${labStr}<p style="margin:5px 0;">${h.notes || ''}</p><ul style="margin:5px 0; padding-left:20px; font-size:13px;">${h.meds.map(m => `<li>${m.type} ${m.name} (${m.strength})</li>`).join('')}</ul></div>`;
                    }).join('');
                }
            } else sec.style.display = 'none';
        }

        function addDrugRow() {
            rowCount++;
            const container = document.getElementById('drugListContainer');
            const div = document.createElement('div'); div.className = 'drug-row'; div.id = `row-${rowCount}`;
            const doseOpts = `<option value="0">0</option><option value="0.5">¬Ω</option><option value="2">2</option><option value="3">3</option>`; 
            
            div.innerHTML = `
                <div class="col-name"><label>Medicine Name</label><div class="mic-wrapper"><input list="allMedicines" id="name-${rowCount}" placeholder="Search..." oninput="updateStrengths(${rowCount})"></div><div id="missing-alert-${rowCount}"></div>
                <div class="form-check-group"><label class="form-check-label"><input type="checkbox" id="type-tab-${rowCount}" onclick="handleTypeCheck(${rowCount}, 'tab')" checked> TAB</label><label class="form-check-label"><input type="checkbox" id="type-syp-${rowCount}" onclick="handleTypeCheck(${rowCount}, 'syp')"> Syp</label><label class="form-check-label"><input type="checkbox" id="type-cap-${rowCount}" onclick="handleTypeCheck(${rowCount}, 'cap')"> Cap</label></div></div>
                <div class="col-weight">
                    <label>Strength</label>
                    <select id="str-select-${rowCount}" onchange="handleStrengthChange(${rowCount})"><option value="">--</option></select>
                    <div id="str-manual-box-${rowCount}" style="display:none; align-items:center; gap:5px;">
                        <input type="text" id="str-input-${rowCount}" placeholder="Type...">
                        <button class="btn btn-red btn-sm" style="padding:2px 6px;" onclick="toggleStrengthMode(${rowCount}, 'select')">‚úï</button>
                    </div>
                </div>
                <div class="col-small"><label>M</label><div class="dose-input-group"><select id="m-${rowCount}" onchange="handleDoseInput(${rowCount},'m','dropdown')">${doseOpts}</select><label class="checkbox-label"><input type="checkbox" id="m-chk-${rowCount}" onchange="handleDoseInput(${rowCount},'m','check')" checked></label></div></div>
                <div class="col-small"><label>A</label><div class="dose-input-group"><select id="a-${rowCount}" onchange="handleDoseInput(${rowCount},'a','dropdown')">${doseOpts}</select><label class="checkbox-label"><input type="checkbox" id="a-chk-${rowCount}" onchange="handleDoseInput(${rowCount},'a','check')"></label></div></div>
                <div class="col-small"><label>N</label><div class="dose-input-group"><select id="n-${rowCount}" onchange="handleDoseInput(${rowCount},'n','dropdown')">${doseOpts}</select><label class="checkbox-label"><input type="checkbox" id="n-chk-${rowCount}" onchange="handleDoseInput(${rowCount},'n','check')" checked></label></div></div>
                <div class="col-days"><label>Duration</label><select id="d-preset-${rowCount}" onchange="handleDurationChange(${rowCount})"><option value="">Select</option><option value="5">5 Days</option><option value="10">10 Days</option><option value="15">15 Days</option><option value="30">1 Month</option><option value="60">2 Months</option><option value="90">3 Months</option><option value="120">4 Months</option><option value="150">5 Months</option><option value="180">6 Months</option><option value="manual">Manual</option></select>
                <div class="duration-checks"><label class="dur-check-label"><input type="checkbox" id="d-5-${rowCount}" onclick="setDurationChk(${rowCount},5)"> 5d</label><label class="dur-check-label"><input type="checkbox" id="d-10-${rowCount}" onclick="setDurationChk(${rowCount},10)"> 10d</label><label class="dur-check-label"><input type="checkbox" id="d-15-${rowCount}" onclick="setDurationChk(${rowCount},15)"> 15d</label><label class="dur-check-label"><input type="checkbox" id="d-30-${rowCount}" onclick="setDurationChk(${rowCount},30)"> 1m</label></div>
                <div id="d-manual-container-${rowCount}" style="display:none; margin-top:5px;"><input type="number" id="d-num-${rowCount}" style="width:50px" oninput="calculateTotal(${rowCount})"><select id="d-unit-${rowCount}" onchange="calculateTotal(${rowCount})"><option value="1">Days</option><option value="30">Months</option></select></div></div>
                <div class="col-total"><label>Total</label><input type="text" id="t-${rowCount}" readonly style="background:var(--bg); border:none;"></div>
                <div class="col-action"><button class="btn btn-secondary btn-sm" style="color:var(--error);" onclick="document.getElementById('row-${rowCount}').remove()">X</button></div>
            `;
            container.appendChild(div); attachMicListeners(`name-${rowCount}`);
        }

        function calculateTotal(rid) {
            const v=(s)=>document.getElementById(`${s}-chk-${rid}`).checked ? 1 : parseFloat(document.getElementById(`${s}-${rid}`).value)||0;
            const m=v('m'), a=v('a'), n=v('n');
            let d=0, p=document.getElementById(`d-preset-${rid}`).value;
            if(p==='manual') d=(parseFloat(document.getElementById(`d-num-${rid}`).value)||0) * parseFloat(document.getElementById(`d-unit-${rid}`).value);
            else d=parseFloat(p)||0;
            document.getElementById(`t-${rid}`).value = Math.ceil((m+a+n)*d);
        }

        function renderTemplateChips() {
            const container = document.getElementById('templateChipContainer'); const manageBtn = document.createElement('span'); manageBtn.className = 'template-add-btn'; manageBtn.innerText = '+ Manage Templates'; manageBtn.onclick = openTemplateManager; container.innerHTML = '';
            clinicalTemplates.forEach(t => { const chip = document.createElement('span'); chip.className = 'template-chip'; chip.innerText = t.name; chip.onclick = () => startTemplateFlow(t); container.appendChild(chip); }); container.appendChild(manageBtn);
        }
        function startTemplateFlow(t) {
            currentTemplateAction = { template: t };
            const sub = t.subtypes || [], dur = t.durations || [];
            if(sub.length > 0) {
                openSelectionModal(`Type of ${t.name}`, sub, (s) => { 
                    currentTemplateAction.subtype = s; 
                    if(dur.length > 0) {
                        const durOptions = [...dur, "‚úé Manual Input"];
                        openSelectionModal(`Duration`, durOptions, (d) => {
                            if (d === "‚úé Manual Input") {
                                document.getElementById('manualDurationInput').value = '';
                                document.getElementById('manualDurationModal').style.display = 'flex';
                                document.getElementById('manualDurationInput').focus();
                            } else {
                                currentTemplateAction.duration = d; 
                                finalizeTemplate();
                            }
                        }); 
                    } else finalizeTemplate(); 
                });
            } else finalizeTemplate();
        }

        window.saveManualDuration = () => {
            const val = document.getElementById('manualDurationInput').value.trim();
            if(!val) return showToast("Please enter a duration", "error");
            currentTemplateAction.duration = val;
            closeModal('manualDurationModal');
            finalizeTemplate();
        }

        function finalizeTemplate() {
            const t = currentTemplateAction; let txt = `‚Ä¢ Patient has ${t.template.name}`;
            if(t.subtype) txt += ` (${t.subtype})`; if(t.duration) txt += ` for ${t.duration}`; txt += ".";
            const area = document.getElementById('docDetails'); area.value += (area.value ? "\n" : "") + txt; 
            area.style.height = 'auto'; area.style.height = (area.scrollHeight) + 'px'; 
            closeModal('selectionModal');
        }
        function openSelectionModal(title, opts, cb) {
            document.getElementById('selectionTitle').innerText = title; const grid = document.getElementById('selectionContainer'); grid.innerHTML = '';
            opts.forEach(o => { const btn = document.createElement('div'); btn.className = 'selection-btn'; btn.innerText = o; btn.onclick = () => cb(o); grid.appendChild(btn); });
            document.getElementById('selectionModal').style.display = 'flex';
        }
        window.openTemplateManager = () => document.getElementById('templateManagerModal').style.display = 'flex';
        window.saveNewTemplate = async () => {
            const name = document.getElementById('tplName').value, subs = document.getElementById('tplTypes').value.split(','), durs = document.getElementById('tplDurations').value.split(',');
            if(!name) return; await addDoc(collection(db, "clinicalTemplates"), { name, subtypes: subs, durations: durs });
            document.getElementById('tplName').value=''; document.getElementById('tplTypes').value=''; document.getElementById('tplDurations').value='';
        };
        window.deleteTemplate = async (id) => { if(confirm("Delete?")) await deleteDoc(doc(db, "clinicalTemplates", id)); };
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        function renderTemplateManagerList() { const div = document.getElementById('templateListContainer'); div.innerHTML=''; clinicalTemplates.forEach(t=>{ div.innerHTML+=`<div style="display:flex;justify-content:space-between;padding:8px;border-bottom:1px solid var(--border);"><span>${t.name}</span><button class="btn btn-red btn-sm" onclick="deleteTemplate('${t.id}')">Del</button></div>`; }); }

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition(); recognition.interimResults = true; recognition.lang = 'en-US';
            recognition.onresult = (e) => {
                if (!activeInputId) return; let interim = '';
                for (let i = e.resultIndex; i < e.results.length; ++i) e.results[i].isFinal ? finalTranscript += e.results[i][0].transcript : interim += e.results[i][0].transcript;
                const input = document.getElementById(activeInputId);
                if(input.tagName === 'INPUT') { input.value = finalTranscript + interim; if(activeInputId.includes('name-')) handleMedicineInput(activeInputId.split('-')[1]); if(activeInputId === 'medManagerSearch') renderMedManagerList(); } else input.value = finalTranscript + interim;
            };
            recognition.onerror = () => stopListening();
            recognition.onend = () => { if(activeInputId && isAutoMicOn && ['docDetails'].includes(activeInputId)) try{recognition.start()}catch(e){} else stopListeningUI(); };
        }
        window.toggleAutoMic = () => { isAutoMicOn = document.getElementById('autoMicToggle').checked; if(!isAutoMicOn) stopListening(); };
        window.handleManualMicClick = (e, id) => { e.preventDefault(); e.stopPropagation(); if(activeInputId === id) stopListening(); else { document.getElementById(id).focus(); startListening(id); } };
        function startListening(id) {
            if(!recognition) return; if(activeInputId === id) return; if(activeInputId) stopListening();
            activeInputId = id; const el = document.getElementById(id);
            if(el.tagName === 'INPUT') { el.value=''; finalTranscript=''; } else { finalTranscript=el.value; if(finalTranscript && !finalTranscript.endsWith(' ')) finalTranscript+=' '; }
            let btnId = (id==='docDetails'?'mic-docDetails':(id.includes('name-')?`mic-${id.split('-')[1]}`:`mic-${id}`));
            const btn = document.getElementById(btnId); if(btn) btn.classList.add('listening');
            recognition.continuous = ['docDetails'].includes(id); try{recognition.start()}catch(e){}
        }
        function stopListening() { if(!recognition)return; recognition.stop(); stopListeningUI(); activeInputId=null; }
        function stopListeningUI() { document.querySelectorAll('.mic-btn').forEach(b => b.classList.remove('listening')); }
        function attachMicListeners(id) {
            const el = document.getElementById(id); if(!el)return;
            el.addEventListener('focus', () => { el.select(); if(isAutoMicOn) startListening(id); });
            el.addEventListener('blur', (e) => { setTimeout(() => { if(document.activeElement!==el) stopListening(); }, 100); });
        }
    </script>

</body></html>
