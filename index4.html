<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro Specialities - Auto Calc System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1e3a8a;
            --primary-light: #eff6ff;
            --dr-red: #b91c1c;
            --text: #1f2937;
            --bg: #f3f4f6;
            --border: #e5e7eb;
        }

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; }

        /* --- LAYOUT & TABS --- */
        .container { max-width: 1400px; margin: 0 auto; }

        .app-header {
            background: white; padding: 15px 25px; border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 25px;
        }

        .nav-pills { display: flex; gap: 10px; background: var(--bg); padding: 5px; border-radius: 8px; }
        .nav-btn {
            border: none; background: transparent; padding: 8px 20px; border-radius: 6px;
            font-weight: 600; cursor: pointer; color: #6b7280; transition: 0.2s;
        }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & FORMS --- */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-doctor { display: grid; grid-template-columns: 350px 1fr; gap: 20px; align-items: start; }
        
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: 600; color: #4b5563; margin-bottom: 5px; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 14px; font-family: inherit;
        }
        input:focus, select:focus { outline: none; border-color: var(--primary); ring: 2px solid var(--primary-light); }

        /* --- BUTTONS --- */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: white; border: 1px solid var(--border); color: var(--text); }
        .btn-green { background: #059669; color: white; }
        .btn-red { background: #ef4444; color: white; }

        /* --- DOCTOR LIST & DRUG ROWS --- */
        .patient-list-item {
            padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px;
            cursor: pointer; transition: 0.2s; background: #f9fafb;
        }
        .patient-list-item:hover { border-color: var(--primary); }
        .patient-list-item.selected { background: var(--primary-light); border-color: var(--primary); border-left: 4px solid var(--primary); }

        .drug-row {
            display: flex; gap: 10px; align-items: flex-end; background: #f8fafc;
            padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 10px;
        }
        /* Columns sizes for the drug row input */
        .col-name { flex: 3; }
        .col-weight { flex: 1.5; }
        .col-small { flex: 0.8; } /* M, A, N */
        .col-days { flex: 1; }   /* Days */
        .col-total { flex: 1; }  /* Total */
        .col-action { flex: 0.2; }

        /* --- PRINT STYLES (Exact match) --- */
        @media print {
            body, .container { background: white; margin: 0; padding: 0; max-width: 100%; }
            .no-print, .app-header, .patient-list-section, .btn, .add-drug-btn { display: none !important; }
            .print-only { display: block !important; }
            .card { box-shadow: none; padding: 0; border: none; }
            
            .print-container { padding: 0 10px; font-family: 'Times New Roman', serif; }
            
            .print-header { display: flex; justify-content: space-between; border-bottom: 1px solid #000; padding-bottom: 10px; margin-bottom: 5px; }
            
            .dr-info h1 { color: #b91c1c !important; font-size: 26px; margin: 0; font-weight: 900; text-transform: uppercase; -webkit-print-color-adjust: exact; }
            .dr-info p { margin: 2px 0; font-size: 12px; font-weight: bold; color: #000; }
            
            .clinic-info { text-align: right; }
            .clinic-name { 
                color: #1e3a8a !important; font-size: 20px; font-weight: 900; 
                text-transform: uppercase; border: 2px solid #1e3a8a; padding: 2px 8px;
                display: inline-block; -webkit-print-color-adjust: exact;
            }
            .clinic-details { font-size: 11px; margin-top: 5px; line-height: 1.4; color: #000; }

            .rx-badge { text-align: center; margin: 15px 0; }
            .rx-badge span {
                background: #222; color: white !important; padding: 4px 25px;
                border-radius: 4px; font-weight: bold; letter-spacing: 2px;
                font-family: sans-serif; font-size: 14px;
                -webkit-print-color-adjust: exact;
            }

            .print-meta { margin: 20px 0; font-size: 16px; font-weight: bold; display: flex; flex-direction: column; gap: 15px; }
            .meta-row { display: flex; align-items: baseline; }
            .dotted-line { border-bottom: 1px dotted #000; flex-grow: 1; margin-left: 10px; padding-left: 10px; }

            .rx-table { 
                width: 100%; border-collapse: collapse; margin-top: 10px; 
                border: 2px solid #000;
            }
            .rx-table th { 
                border: 1px solid #000; padding: 6px; font-size: 12px; 
                background: #e5e7eb !important; -webkit-print-color-adjust: exact;
                text-align: center; font-weight: bold; font-family: sans-serif;
            }
            .rx-table td { 
                border: 1px solid #000; padding: 8px 5px; font-size: 16px; 
                text-align: center; height: 40px; vertical-align: middle; font-weight: 600;
                color: #1e3a8a !important; 
                -webkit-print-color-adjust: exact;
            }
            .rx-table td.drug-name-cell { text-align: left; padding-left: 15px; color: #000 !important; }
            
            .lang-sub { display: block; font-size: 9px; font-weight: normal; margin-top: 2px; }

            .print-footer { position: fixed; bottom: 40px; right: 40px; text-align: right; }
        }
        .print-only { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <div class="app-header no-print">
            <div>
                <h2 style="margin:0; color:var(--primary);">Neuro Specialities Centre</h2>
                <small style="color:#6b7280;">Manager v3.0 (Auto-Calc)</small>
            </div>
            <div class="nav-pills">
                <button class="nav-btn active" onclick="switchPage('reception')">Reception Desk</button>
                <button class="nav-btn" onclick="switchPage('doctor')">Doctor Chamber</button>
            </div>
        </div>

        <div id="receptionPage" class="page active no-print">
            <div class="grid-2">
                <div class="card">
                    <span class="card-title">New Patient Registration</span>
                    <form id="regForm" onsubmit="event.preventDefault(); registerPatient();">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Patient Name *</label>
                                <input type="text" id="regName" required>
                            </div>
                            <div class="form-group">
                                <label>Age & Sex *</label>
                                <input type="text" id="regAgeSex" placeholder="e.g. 45 / Male" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Phone Number</label>
                            <input type="tel" id="regPhone">
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <input type="text" id="regAddress">
                        </div>
                        <div class="form-group">
                            <label>Provisional Diagnosis</label>
                            <textarea id="regDiagnosis" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Register Patient</button>
                    </form>
                </div>
                
                <div class="card">
                    <span class="card-title">Today's Statistics</span>
                    <h1 id="totalPatients" style="font-size: 48px; color: var(--primary); margin: 20px 0;">0</h1>
                    <p style="color: #6b7280;">Patients Registered</p>
                    <div id="recentReg" style="margin-top:20px; font-size:13px;"></div>
                </div>
            </div>
        </div>

        <div id="doctorPage" class="page no-print">
            <div class="grid-doctor">
                <div class="card patient-list-section" style="height: 80vh; overflow-y: auto;">
                    <span class="card-title">Patient Queue</span>
                    <input type="text" placeholder="üîç Search name..." onkeyup="filterPatients(this.value)" style="margin-bottom: 15px;">
                    <div id="patientList"></div>
                </div>

                <div id="workspace" style="display: none;">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
                            <div>
                                <h2 id="pNameDisplay" style="margin:0;">-</h2>
                                <small id="pDetailsDisplay" style="color:#6b7280;">-</small>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-secondary" onclick="toggleHistory()">üìú History</button>
                                <button class="btn btn-primary" onclick="printPrescription()">üñ®Ô∏è Print</button>
                            </div>
                        </div>

                        <div id="historySection" style="display:none; background:#f0f9ff; padding:15px; border-radius:8px; margin-bottom:20px;">
                            <h4>Previous Visits</h4>
                            <div id="historyContent"></div>
                        </div>

                        <div style="background:#fefce8; padding:10px; border-radius:6px; margin-bottom:15px; font-size:13px; color:#854d0e; border:1px solid #fef08a;">
                            üí° <strong>Tip:</strong> Total quantity is calculated automatically: (Morning + Afternoon + Night) √ó Days.
                        </div>

                        <div id="drugListContainer"></div>

                        <div style="margin-top: 20px; display:flex; justify-content:space-between;">
                            <button class="btn btn-green" onclick="addDrugRow()">+ Add Medicine</button>
                            <button class="btn btn-primary" onclick="saveToHistory()">üíæ Save Record</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="print-only print-container">
        <div class="print-header">
            <div class="dr-info">
                <h1>Dr. G.M. WALI</h1>
                <p>M.D. D.M.</p>
                <p>CHIEF NEUROLOGIST</p>
                <p>K.M.C. 12671</p>
            </div>
            <div class="clinic-info">
                <div class="clinic-name">NEURO SPECIALITIES CENTRE</div>
                <div class="clinic-details">
                    3933, CLUB ROAD, BELGAUM-590 001<br>
                    Ph.: 0831-2430625, E-mail: walidoc@hotmail.com
                </div>
            </div>
        </div>

        <div class="rx-badge">
            <span>PRESCRIPTION</span>
        </div>

        <div class="print-meta">
            <div class="meta-row">
                Name : <span id="printName" class="dotted-line"></span>
            </div>
            <div class="meta-row">
                Date : <span id="printDate" class="dotted-line" style="width: 200px; flex-grow: 0;"></span>
            </div>
        </div>

        <table class="rx-table">
            <thead>
                <tr>
                    <th width="5%">Sl.<br>No.</th>
                    <th width="40%">DRUG NAME</th>
                    <th width="10%">Morning<br><span class="lang-sub">‡≤¨‡≥Ü‡≤≥‡≤ø‡≤ó‡≥ç‡≤ó‡≥Ü / ‡§∏‡§ï‡§æ‡§≥‡•Ä</span></th>
                    <th width="10%">Afternoon<br><span class="lang-sub">‡≤Æ‡≤ß‡≥ç‡≤Ø‡≤æ‡≤π‡≥ç‡≤® / ‡§¶‡•Å‡§™‡§æ‡§∞‡•Ä</span></th>
                    <th width="10%">Night<br><span class="lang-sub">‡≤∞‡≤æ‡≤§‡≥ç‡≤∞‡≤ø / ‡§∞‡§æ‡§§‡•ç‡§∞‡•Ä</span></th>
                    <th width="10%">Total Qty.</th>
                </tr>
            </thead>
            <tbody id="printTableBody"></tbody>
            <tbody id="fillerRows"></tbody>
        </table>

        <div class="print-footer">
            <strong>Signature</strong>
        </div>
    </div>

    <datalist id="allMedicines"></datalist>

    <script>
        // --- DATA ---
        const medicineDB = {
            "Paracetamol": ["500 mg", "650 mg", "Syrup"],
            "Gabapentin": ["100 mg", "300 mg", "400 mg"],
            "Pregabalin": ["50 mg", "75 mg", "150 mg"],
            "Metformin": ["500 mg", "850 mg", "1000 mg"],
            "Atorvastatin": ["10 mg", "20 mg", "40 mg"],
            "Levothyroxine": ["25 mcg", "50 mcg", "100 mcg"],
            "Amitriptyline": ["10 mg", "25 mg"],
            "Clopidogrel": ["75 mg", "150 mg"],
            "Pantoprazole": ["40 mg", "Injection"],
            "Vitamin B12": ["Tablet", "Injection"]
        };

        let patients = JSON.parse(localStorage.getItem('neuroPatients')) || [];
        let currentPatientId = null;
        let rowCount = 0;

        document.addEventListener('DOMContentLoaded', () => {
            updateStats();
            renderPatientList();
            populateDatalist();
        });

        function populateDatalist() {
            const dl = document.getElementById('allMedicines');
            Object.keys(medicineDB).forEach(med => {
                const opt = document.createElement('option');
                opt.value = med;
                dl.appendChild(opt);
            });
        }

        // --- NAVIGATION & RECEPTION ---
        function switchPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            const btns = document.querySelectorAll('.nav-btn');
            if(page === 'reception') btns[0].classList.add('active');
            else btns[1].classList.add('active');
        }

        function registerPatient() {
            const newPatient = {
                id: Date.now(),
                name: document.getElementById('regName').value,
                ageSex: document.getElementById('regAgeSex').value,
                phone: document.getElementById('regPhone').value,
                address: document.getElementById('regAddress').value,
                diagnosis: document.getElementById('regDiagnosis').value,
                regDate: new Date().toLocaleDateString(),
                history: []
            };
            patients.push(newPatient);
            saveData();
            alert('Patient Registered!');
            document.getElementById('regForm').reset();
            updateStats();
            renderPatientList();
        }

        function updateStats() {
            document.getElementById('totalPatients').innerText = patients.length;
            const recentDiv = document.getElementById('recentReg');
            recentDiv.innerHTML = patients.slice(-3).reverse().map(p => 
                `<div style="padding:5px 0; border-bottom:1px solid #eee;">${p.name} <span style="float:right; color:#888;">${p.regDate}</span></div>`
            ).join('');
        }

        // --- DOCTOR & CALCULATIONS ---
        function renderPatientList(filter = "") {
            const container = document.getElementById('patientList');
            container.innerHTML = "";
            const filtered = patients.filter(p => p.name.toLowerCase().includes(filter.toLowerCase()));
            filtered.reverse().forEach(p => {
                const div = document.createElement('div');
                div.className = `patient-list-item ${currentPatientId === p.id ? 'selected' : ''}`;
                div.onclick = () => selectPatient(p.id);
                div.innerHTML = `<strong>${p.name}</strong><br><small>${p.ageSex}</small>`;
                container.appendChild(div);
            });
        }

        function filterPatients(val) { renderPatientList(val); }

        function selectPatient(id) {
            currentPatientId = id;
            const p = patients.find(x => x.id === id);
            document.getElementById('workspace').style.display = 'block';
            document.getElementById('pNameDisplay').innerText = p.name;
            document.getElementById('pDetailsDisplay').innerText = `${p.ageSex} | ${p.phone}`;
            renderPatientList(document.querySelector('input[placeholder="üîç Search name..."]').value);
            document.getElementById('drugListContainer').innerHTML = '';
            addDrugRow();
            document.getElementById('historySection').style.display = 'none';
        }

        function addDrugRow() {
            rowCount++;
            const container = document.getElementById('drugListContainer');
            const div = document.createElement('div');
            div.className = 'drug-row';
            div.id = `row-${rowCount}`;
            
            // Added DAYS column and oninput listeners
            div.innerHTML = `
                <div class="col-name">
                    <label>Medicine Name</label>
                    <input list="allMedicines" id="name-${rowCount}" placeholder="Search..." onchange="updateStrengths(${rowCount})">
                </div>
                <div class="col-weight">
                    <label>Strength</label>
                    <select id="strength-${rowCount}"><option value="">--</option></select>
                </div>
                <div class="col-small">
                    <label>Morn</label>
                    <input type="number" id="m-${rowCount}" placeholder="1" min="0" oninput="calculateTotal(${rowCount})">
                </div>
                <div class="col-small">
                    <label>Aft</label>
                    <input type="number" id="a-${rowCount}" placeholder="0" min="0" oninput="calculateTotal(${rowCount})">
                </div>
                <div class="col-small">
                    <label>Night</label>
                    <input type="number" id="n-${rowCount}" placeholder="1" min="0" oninput="calculateTotal(${rowCount})">
                </div>
                <div class="col-days">
                    <label style="color:#b91c1c;">Days</label>
                    <input type="number" id="d-${rowCount}" placeholder="Days" min="0" oninput="calculateTotal(${rowCount})">
                </div>
                <div class="col-total">
                    <label>Total</label>
                    <input type="text" id="t-${rowCount}" placeholder="0" readonly style="background:#f3f4f6; font-weight:bold;">
                </div>
                <div class="col-action">
                    <label>&nbsp;</label>
                    <button class="btn btn-red" style="padding:10px;" onclick="document.getElementById('row-${rowCount}').remove()">X</button>
                </div>
            `;
            container.appendChild(div);
        }

        // --- AUTO CALCULATION LOGIC ---
        function calculateTotal(rid) {
            const m = parseFloat(document.getElementById(`m-${rid}`).value) || 0;
            const a = parseFloat(document.getElementById(`a-${rid}`).value) || 0;
            const n = parseFloat(document.getElementById(`n-${rid}`).value) || 0;
            const days = document.getElementById(`d-${rid}`).value; // Keep as string initially to check empty
            const totalField = document.getElementById(`t-${rid}`);

            // Validation: If days is 0 or empty, return Error
            if (days === "" || parseFloat(days) <= 0) {
                totalField.value = "Error";
                totalField.style.color = "red";
                totalField.style.borderColor = "red";
                return;
            }

            // Calculation: (M + A + N) * Days
            const dailyDose = m + a + n;
            const total = dailyDose * parseFloat(days);

            totalField.value = total;
            totalField.style.color = "black";
            totalField.style.borderColor = "#e5e7eb";
        }

        function updateStrengths(rowId) {
            const nameVal = document.getElementById(`name-${rowId}`).value;
            const select = document.getElementById(`strength-${rowId}`);
            select.innerHTML = '<option value="">--</option>';
            const key = Object.keys(medicineDB).find(k => k.toLowerCase() === nameVal.toLowerCase());
            const options = key ? medicineDB[key] : ["Tablet", "Syrup", "Inj", "mg", "ml"];
            options.forEach(opt => {
                const el = document.createElement('option');
                el.value = opt;
                el.innerText = opt;
                select.appendChild(el);
            });
        }

        function saveToHistory() {
            if(!currentPatientId) return;
            const pIndex = patients.findIndex(x => x.id === currentPatientId);
            const drugs = [];
            
            document.querySelectorAll('.drug-row').forEach(row => {
                const rid = row.id.split('-')[1];
                const name = document.getElementById(`name-${rid}`).value;
                const total = document.getElementById(`t-${rid}`).value;

                if(name && total !== "Error") {
                    drugs.push({
                        name: name,
                        strength: document.getElementById(`strength-${rid}`).value,
                        m: document.getElementById(`m-${rid}`).value,
                        a: document.getElementById(`a-${rid}`).value,
                        n: document.getElementById(`n-${rid}`).value,
                        days: document.getElementById(`d-${rid}`).value,
                        t: total
                    });
                }
            });

            if(drugs.length === 0) return alert("Please check inputs. Total cannot be Error.");

            patients[pIndex].history.push({
                date: new Date().toLocaleDateString(),
                meds: drugs
            });
            saveData();
            alert("Prescription saved to History");
        }

        function toggleHistory() {
            const sec = document.getElementById('historySection');
            const cont = document.getElementById('historyContent');
            if(sec.style.display === 'none') {
                sec.style.display = 'block';
                const p = patients.find(x => x.id === currentPatientId);
                if(!p.history.length) cont.innerHTML = "No history found.";
                else {
                    cont.innerHTML = p.history.slice().reverse().map(h => `
                        <div style="border-bottom:1px solid #ccc; padding:10px 0;">
                            <strong>${h.date}</strong>
                            <ul style="margin:5px 0; padding-left:20px;">
                                ${h.meds.map(m => `<li>${m.name} ${m.strength} (${m.m}-${m.a}-${m.n}) for ${m.days} days = Qty: ${m.t}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');
                }
            } else { sec.style.display = 'none'; }
        }

        function printPrescription() {
            const p = patients.find(x => x.id === currentPatientId);
            document.getElementById('printName').innerText = p.name;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString();

            const tbody = document.getElementById('printTableBody');
            tbody.innerHTML = '';
            let sl = 1;

            document.querySelectorAll('.drug-row').forEach(row => {
                const rid = row.id.split('-')[1];
                const name = document.getElementById(`name-${rid}`).value;
                const total = document.getElementById(`t-${rid}`).value;

                if(name && total !== "Error") {
                    // M, A, N logic: Convert 0 to 0 (or empty string if you prefer blank for 0)
                    // Currently showing the number.
                    tbody.innerHTML += `
                        <tr>
                            <td>${sl++}</td>
                            <td class="drug-name-cell">${name} <span style="font-size:12px; margin-left:5px;">${document.getElementById(`strength-${rid}`).value}</span></td>
                            <td>${document.getElementById(`m-${rid}`).value || 0}</td>
                            <td>${document.getElementById(`a-${rid}`).value || 0}</td>
                            <td>${document.getElementById(`n-${rid}`).value || 0}</td>
                            <td>${total}</td>
                        </tr>
                    `;
                }
            });

            const fillerBody = document.getElementById('fillerRows');
            fillerBody.innerHTML = '';
            for(let i=0; i<6; i++) {
                fillerBody.innerHTML += '<tr><td>&nbsp;</td><td></td><td></td><td></td><td></td><td></td></tr>';
            }

            window.print();
        }

        function saveData() { localStorage.setItem('neuroPatients', JSON.stringify(patients)); }
    </script>
</body>
</html>